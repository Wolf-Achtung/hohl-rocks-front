// hohl.rocks – BubbleEngine (hardened) v2.5.3
(function () {
  'use strict';
  function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
  function escapeForRegExp(s){return String(s).replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
  function safeRegExp(pattern,flags){if(!pattern)return null;if(typeof pattern==='string'&&pattern.startsWith('/')&&pattern.lastIndexOf('/')>0){const last=pattern.lastIndexOf('/');const body=pattern.slice(1,last);const f=flags||pattern.slice(last+1);try{return new RegExp(body,f);}catch{}}try{return new RegExp(escapeForRegExp(String(pattern)),flags||'i');}catch{return null;}}
  function matches(text,pattern){if(!pattern)return true;const rx=safeRegExp(pattern,'i');if(rx)return rx.test(text);return String(text).toLowerCase().indexOf(String(pattern).toLowerCase())!==-1;}
  const $=(s,e)=>(e||document).querySelector(s); const $$=(s,e)=>Array.from((e||document).querySelectorAll(s));
  function ensureModal(){let m=document.getElementById('bubble-modal');if(m)return m;m=document.createElement('div');m.id='bubble-modal';m.setAttribute('role','dialog');m.setAttribute('aria-modal','true');m.style.display='none';m.style.position='fixed';m.style.inset='0';m.style.background='rgba(8,10,16,.45)';m.style.backdropFilter='blur(6px)';m.style.zIndex='2147483644';m.innerHTML='<div id="bubble-modal-content" class="dialog"><button id="bubble-modal-close" class="close" aria-label="Schließen">×</button><div class="be-stream" aria-live="polite"></div></div>';document.body.appendChild(m);m.addEventListener('click',(e)=>{if(e.target===m)hideModal();});document.getElementById('bubble-modal-close').addEventListener('click',hideModal);return m;}
  function showModal(){const m=ensureModal();m.style.display='block';document.documentElement.classList.add('modal-open');document.body.classList.add('modal-open');const b=document.getElementById('bubble-modal-close');if(b)b.focus();}
  function hideModal(){const m=document.getElementById('bubble-modal');if(m)m.style.display='none';document.documentElement.classList.remove('modal-open');document.body.classList.remove('modal-open');}
  async function runBubble(id,payload){try{const res=await fetch('/api/run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({input:`[Bubble ${id}]`,payload})});const data=await res.json();return data?.result??'';}catch(e){console.error('[bubbleEngine] runBubble failed',e);return 'Entschuldigung, das hat nicht geklappt.';}}
  async function renderAnswer(el,result){if(typeof result==='string'&&result.startsWith('__HTML__')){el.insertAdjacentHTML('beforeend',result.slice(8));return;}el.innerHTML=escapeHtml(String(result)).replace(/\n/g,'<br>');}
  function createBubble(btn){btn.addEventListener('click',async()=>{const id=Number(btn.dataset.id||'0')||0;showModal();const box=document.querySelector('#bubble-modal .be-stream');if(box)box.innerHTML='<div style="opacity:.85">…denke nach…</div>';const payload={};for(const a of btn.attributes){if(a.name.startsWith('data-')&&a.name!=='data-id'){payload[a.name.slice(5).toUpperCase()]=a.value;}}const result=await runBubble(id,payload);await renderAnswer(box,result);},{passive:true});}
  function initBubbles(){const nodes=$$('.bubble,[data-bubble],[data-id]');nodes.forEach(createBubble);}
  function applyFilter(q){const cards=$$('.prompt-card');const s=(q||'').trim();for(const c of cards){const txt=c.getAttribute('data-text')||c.textContent||'';const ok=s?matches(txt,s):true;c.style.display=ok?'':'none';}}
  const search=document.getElementById('prompt-search');if(search){search.addEventListener('input',e=>applyFilter(e.target.value||''));}
  window.addEventListener('DOMContentLoaded',()=>{try{initBubbles();}catch(e){console.error('Bubble init failed',e);}});
  window.addEventListener('error',(ev)=>{if(String(ev?.error?.message||'').includes('Invalid regular expression')){ev.preventDefault();console.warn('[bubbleEngine] Caught invalid regex – using fallback.');}},true);
})();